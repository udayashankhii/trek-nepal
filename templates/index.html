<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <title>EverTrek AI | Himalayan Guide</title>

    <style>
        /* 2. ADDED: Markdown Specific Styling */
        /* This ensures the AI's tables and lists look good in Tailwind */
        .markdown-content h2 { font-size: 1.25rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; color: #1e40af; }
        .markdown-content h3 { font-size: 1.1rem; font-weight: bold; margin-top: 0.8rem; }
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        .markdown-content li { margin-bottom: 0.25rem; }
        
        /* Table Styling */
        .markdown-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; background: #fff; font-size: 0.9rem; }
        .markdown-content th { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 8px; text-align: left; font-weight: bold; }
        .markdown-content td { border: 1px solid #e2e8f0; padding: 8px; }
        
        /* Smooth Scrolling */
        #chat-box { scroll-behavior: smooth; }
    </style>
</head>

<body class="bg-slate-900 h-screen flex flex-col items-center justify-center p-4">
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden h-[80vh]">
        <div class="bg-blue-700 p-4 text-white flex items-center gap-3">
            <div class="bg-white/20 p-2 rounded-full"><i class="fas fa-mountain"></i></div>
            <div>
                <h1 class="font-bold text-lg">EverTrek AI Consultant</h1>
                <p class="text-xs text-blue-100">Knowledge Base: 21 Managed Treks</p>
            </div>
        </div>

        <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50">
            <div class="flex flex-col items-start">
                <div class="bg-white border p-3 rounded-2xl rounded-bl-none shadow-sm max-w-[90%] text-gray-700">
                    Namaste! üôè I am your EverTrek consultant. Ask me about our trekking routes, costs, or itineraries.
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border-t flex gap-2">
            <input id="user-input" type="text" placeholder="Ask about Everest, Annapurna, or pricing..." 
                   class="flex-1 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="send()" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-all font-bold">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

<script>
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('user-input');

    // 1. ADD THIS: Configure Marked to handle line breaks and tables correctly
    marked.setOptions({
        breaks: true,
        gfm: true
    });

    async function send() {
        const msg = input.value.trim();
        if(!msg) return;

        // Add User Bubble
        chatBox.innerHTML += `
            <div class="flex flex-col items-end">
                <div class="bg-blue-600 text-white p-3 rounded-2xl rounded-br-none shadow-md max-w-[80%]">${msg}</div>
            </div>`;
        
        input.value = "";
        chatBox.scrollTo(0, chatBox.scrollHeight);

        // Fetch AI Response
        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: msg})
            });
            const data = await res.json();

            // 2. THE CRITICAL CHANGE: Parse the markdown into HTML
            const htmlContent = marked.parse(data.reply);

            // 3. Add AI Bubble using the parsed HTML content
            chatBox.innerHTML += `
                <div class="flex flex-col items-start">
                    <div class="bg-white border p-4 rounded-2xl rounded-bl-none shadow-sm max-w-[90%] text-gray-800 markdown-content">
                        ${htmlContent}
                    </div>
                </div>`;
            
            chatBox.scrollTo(0, chatBox.scrollHeight);
        } catch (error) {
            console.error("Error:", error);
            chatBox.innerHTML += `<div class="text-red-500 text-xs">Failed to connect to server.</div>`;
        }
    }

    // Allow Enter Key
    input.addEventListener("keypress", (e) => { if(e.key === "Enter") send(); });
</script>
</body>
</html>